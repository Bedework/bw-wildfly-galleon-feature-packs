const authenticatedStr="authenticated";const unauthenticatedStr="unauthenticated";const ownerStr="owner";const otherStr="other";const grantStr="grant";const denyStr="deny";const allStr="all";const bwAclWidgetDeleteStr="remove";const bwAclWidgetEntryStr="Entry";const bwAclWidgetAccessStr="Access";const bwAclWidgetInheritedStr="Inherited from";const trashIcon='<img src="/images/common/trashIcon.gif" width="13" height="13" alt="remove"/>';const userIcon='<img src="/images/common/userIcon.gif" width="13" height="13" alt="user"/>';const groupIcon='<img src="/images/common/groupIcon.gif" width="13" height="13" alt="group"/>';const howAllVal="all";const howReadVal="read";const howReadAclVal="read-acl";const howReadCurPrivSetVal="read-curprivset";const howReadFreebusyVal="read-freebusy ";const howWriteVal="write";const howWriteAclVal="write-acl";const howWritePropertiesVal="write-properties";const howWriteContentVal="write-content";const howBindVal="create";const howScheduleVal="schedule";const howScheduleRequestVal="schedule-request";const howScheduleReplyVal="schedule-reply";const howScheduleFreebusyVal="schedule-freebusy";const howUnbindVal="delete";const howUnlockVal="unlock";const howScheduleDeliverVal="schedule-deliver";const howScheduleDeliverInviteVal="schedule-deliver-invite";const howScheduleDeliverReplyVal="schedule-deliver-reply";const howScheduleQueryFreebusyVal="schedule-query-freebusy";const howScheduleSendVal="schedule-send";const howScheduleSendInviteVal="schedule-send-invite";const howScheduleSendReplyVal="schedule-send-reply";const howScheduleSendFreebusyVal="schedule-send-freebusy";const howDenyAllVal="none";const howDenyReadVal="not-read";const howDenyReadAclVal="not-read-acl";const howDenyReadCurPrivSetVal="not-read-curprivset";const howDenyReadFreebusyVal="not-read-freebusy ";const howDenyWriteVal="not-write";const howDenyWriteAclVal="not-write-acl";const howDenyWritePropertiesVal="not-write-properties";const howDenyWriteContentVal="not-write-content";const howDenyBindVal="not-create";const howDenyScheduleVal="not-schedule";const howDenyScheduleRequestVal="not-schedule-request";const howDenyScheduleReplyVal="not-schedule-reply";const howDenyScheduleFreebusyVal="not-schedule-freebusy";const howDenyUnbindVal="not-delete";const howDenyUnlockVal="not-unlock";const howDenyScheduleDeliverVal="not-schedule-deliver";const howDenyScheduleDeliverInviteVal="not-schedule-deliver-invite";const howDenyScheduleDeliverReplyVal="not-schedule-deliver-reply";const howDenyScheduleQueryFreebusyVal="not-schedule-query-freebusy";const howDenyScheduleSendVal="not-schedule-send";const howDenyScheduleSendInviteVal="not-schedule-send-invite";const howDenyScheduleSendReplyVal="not-schedule-send-reply";const howDenyScheduleSendFreebusy="not-schedule-send-freebusy";const inheritedStr="not inherited";const principalPrefix="/principals/";const userPrincipalPrefix="/principals/users/";const groupPrincipalPrefix="/principals/groups/";const resourcePrincipalPrefix="/principals/resources/";const xmlHeader="<?xml version='1.0' encoding='utf-8'  ?>";const nameSpaces="xmlns:D='DAV:' "+"xmlns:C='urn:ietf:params:xml:ns:caldav'";const davNS="D:";const caldavNS="C:";function HowVals(h,cont,davEl,dv,ddv){var how;var contains;var davEl;var dispVal;var denyDispVal;this.how=h;this.contains=cont;this.davEl=davEl;this.dispVal=dv;this.denyDispVal=ddv;this.doesContain=function(ch){return this.contains.match(ch)!==null};this.getDispVal=function(negated){if(negated){return this.denyDispVal}return this.dispVal}}const hows=new function(){var hv=[];hv.push(new HowVals("A","RrPFWapcbStysuNDieqTIEQ","<D:all/>",howAllVal,howDenyAllVal));hv.push(new HowVals("R","rPF","<D:read/>",howReadVal,howDenyReadVal));hv.push(new HowVals("r","","<D:read-acl/>",howReadAclVal,howDenyReadAclVal));hv.push(new HowVals("P","","<D:read-current-user-privilege-set/>",howReadCurPrivSetVal,howDenyReadCurPrivSetVal));hv.push(new HowVals("F","","<C:read-free-busy/>",howReadFreebusyVal,howDenyReadFreebusyVal));hv.push(new HowVals("W","apcbStysuN","<D:write/>",howWriteVal,howDenyWriteVal));hv.push(new HowVals("a","","<D:write-acl/>",howWriteAclVal,howDenyWriteAclVal));hv.push(new HowVals("p","","<D:write-properties/>",howWritePropertiesVal,howDenyWritePropertiesVal));hv.push(new HowVals("c","","<D:write-content/>",howWriteContentVal,howDenyWriteContentVal));hv.push(new HowVals("b","Stys","<D:bind/>",howBindVal,howDenyBindVal));hv.push(new HowVals("S","tys","<C:schedule/>",howScheduleVal,howDenyScheduleVal));hv.push(new HowVals("t","","<C:schedule-request/>",howScheduleRequestVal,howDenyScheduleRequestVal));hv.push(new HowVals("y","","<C:schedule-reply/>",howScheduleReplyVal,howDenyScheduleReplyVal));hv.push(new HowVals("s","","<C:schedule-free-busy/>",howScheduleFreebusyVal,howDenyScheduleFreebusyVal));hv.push(new HowVals("u","","<D:unbind/>",howUnbindVal,howDenyUnbindVal));hv.push(new HowVals("U","","<D:unlock/>",howUnlockVal,howDenyUnlockVal));hv.push(new HowVals("D","ieq","<C:schedule-deliver/>",howScheduleDeliverVal,howDenyScheduleDeliverVal));hv.push(new HowVals("i","","<C:schedule-deliver-invite/>",howScheduleDeliverInviteVal,howDenyScheduleDeliverInviteVal));hv.push(new HowVals("e","","<C:schedule-deliver-reply/>",howScheduleDeliverReplyVal,howDenyScheduleDeliverReplyVal));hv.push(new HowVals("q","","<C:schedule-query-freebusy/>",howScheduleQueryFreebusyVal,howDenyScheduleQueryFreebusyVal));hv.push(new HowVals("T","IEQ","<C:schedule-send/>",howScheduleSendVal,howDenyScheduleSendVal));hv.push(new HowVals("I","","<C:schedule-send-invite/>",howScheduleSendInviteVal,howDenyScheduleSendInviteVal));hv.push(new HowVals("E","","<C:schedule-send-reply/>",howScheduleSendReplyVal,howDenyScheduleSendReplyVal));hv.push(new HowVals("Q","","<C:schedule-send-freebusy/>",howScheduleSendFreebusyVal,howDenyScheduleSendFreebusy));this.getHows=function(ch){for(let i=0;i<hv.length;i++){if(hv[i].how===ch){return hv[i]}}alert("No how values for how = "+ch);return null}};function setupAccessForm(chkBoxObj,formObj){var hvs;hvs=hows.getHows(chkBoxObj.value);if(hvs.contains===""){return}for(i=0;i<formObj.howItem.length;i++){if(hvs.doesContain(formObj.howItem[i].value)){if(chkBoxObj.checked===true){formObj.howItem[i].checked=false;formObj.howItem[i].disabled=true;for(j=0;j<formObj[formObj.howItem[i].id].length;j++){formObj[formObj.howItem[i].id][j].disabled=true}}else{formObj.howItem[i].disabled=false}}}}function toggleAllowDenyFlag(chkBoxObj,formObj){if(chkBoxObj.checked===true){activateAllowDenyFlag(chkBoxObj.id,formObj,false)}else{activateAllowDenyFlag(chkBoxObj.id,formObj,true)}}function activateAllowDenyFlag(val,formObj,disabledFlag){for(i=0;i<formObj[val].length;i++){if(formObj[val][i].type==="radio"){formObj[val][i].disabled=disabledFlag}}}function setAccessHow(formObj){var howString="";if(formObj.setappvar[0].checked===true){for(i=0;i<formObj.basicHowItem.length;i++){if(formObj.basicHowItem[i].checked===true){howString=formObj.basicHowItem[i].value}}}else{for(i=0;i<formObj.howItem.length;i++){if(formObj.howItem[i].checked===true){var howItemId=formObj.howItem[i].id;for(j=0;j<formObj[howItemId].length;j++){if(formObj[howItemId][j].checked===true&&formObj[howItemId][j].type==="radio"){howString+=formObj[howItemId][j].value}}}}}return howString}function BwPrincipal(who,whoType){this.whoType=whoType;if(whoType==="auth"||whoType==="unauth"||whoType==="owner"||whoType==="all"||whoType==="other"){}else{this.who=who;if(whoType==="user"){if(who.indexOf(principalPrefix)!=="0"){who=userPrincipalPrefix+who}}else if(whoType==="group"){if(who.indexOf(principalPrefix)!=="0"){who=groupPrincipalPrefix+who}}else if(whoType==="resource"){if(who.indexOf(principalPrefix)!=="0"){who=resourcePrincipalPrefix+who}}}this.format=function(){switch(whoType){case"user":return userIcon+" "+who;case"group":return groupIcon+" "+who;case"resource":return who;case"auth":return groupIcon+" "+authenticatedStr;case"unauth":return groupIcon+" "+unauthenticatedStr;case"owner":return userIcon+" "+ownerStr;case"other":return groupIcon+" "+otherStr;case"all":return groupIcon+" "+allStr;default:return"***************"+whoType}};this.formatXml=function(){switch(whoType){case"user":return who;case"group":return who;case"resource":return who;case"auth":return authenticatedStr;case"unauth":return unauthenticatedStr;case"owner":return ownerStr;case"other":return otherStr;case"all":return allStr;default:return"***************"+whoType}};this.toXml=function(){var w=this.formatXml();if(whoType==="other"){return"    <D:invert>\n        <D:principal><D:property><D:owner/></D:property></D:principal>\n      </D:invert>"}var res="    <D:principal>\n";if(w.indexOf(principalPrefix)==="0"){res+="      <D:href>"+w+"</D:href>\n"}else if(whoType==="auth"){res+="      <D:authenticated/>\n"}else if(whoType==="unauth"){res+="      <D:unauthenticated/>\n"}else if(whoType==="all"){res+="      <D:all/>\n"}else if(whoType==="owner"){res+="    <D:property><D:owner/></D:property>\n"}else{res+="************??????"+whoType}return res+"    </D:principal>\n"};this.toString=function(){return"bwPrincipal[who="+this.who+", whoType="+this.whoType+"]"};this.equals=function(pr){if(this.whoType!==pr.whoType){return false}return this.who===pr.who}}function BwAce(who,whoType,how,inherited,invert){this.principal=new BwPrincipal(who,whoType);this.how=how;this.inherited=inherited;this.invert=invert;this.equals=function(ace){return this.principal.equals(ace.principal)};this.formatWho=function(){return this.principal.format()};this.formatHow=function(){let formattedHow="";for(var i=0;i<how.length;i++){let h=how.charAt(i);let negated=false;let grantDenyStr=grantStr;if(h==="-"){negated=true;grantDenyStr=denyStr;i++;h=how.charAt(i)}formattedHow+='<span class="'+grantDenyStr+'">'+hows.getHows(h).getDispVal(negated)+"</span>";if(i!==how.length-1){formattedHow+=", "}}return formattedHow};this.formatInherited=function(){if(inherited!==""){return inherited}return inheritedStr};this.howsToXml=function(doGrants){let open=false;let res="";for(var hi=0;hi<how.length;hi++){let h=how.charAt(hi);if(doGrants&&h==="-"){hi++}else if(!doGrants&&h!=="-"){}else{if(h==="-"){hi++;h=how.charAt(hi)}const hvs=hows.getHows(h);if(!open){if(doGrants){res+="    <D:grant>\n"}else{res+="    <D:deny>\n"}open=true}res+="      <D:privilege>"+hvs.davEl+"</D:privilege>\n"}}if(open){if(doGrants){res+="    </D:grant>\n"}else{res+="    </D:deny>\n"}}return res};this.toXml=function(){if(this.inherited!==""){return""}let res="  <D:ace>\n"+this.principal.toXml();res+=this.howsToXml(true);res+=this.howsToXml(false);return res+"  </D:ace>\n"};this.toFormRow=function(row,aceI,id){const td_0=row.insertCell(0);td_0.innerHTML=this.principal.format();const td_1=row.insertCell(1);td_1.innerHTML=this.formatHow();row.insertCell(2).appendChild(document.createTextNode(this.formatInherited()));const td_3=row.insertCell(3);if(this.inherited===""){td_3.innerHTML="<a href=\"javascript:bwAcl.deleteAce('"+aceI+"','"+id+"')\">"+trashIcon+" "+bwAclWidgetDeleteStr+"</a>"}}}var bwAcl=new function(){const aces=[];const savedInherited=[];this.init=function(who,whoType,how,inherited,invert){const newAce=new BwAce(who,whoType,how,inherited,invert);aces.push(newAce);if(inherited!==""){savedInherited.push(newAce)}};this.addAce=function(newAce){for(let i=0;i<aces.length;i++){if(aces[i].equals(newAce)){aces[i]=newAce;return}}aces.push(newAce)};this.update=function(formObj,id){var type;for(i=0;i<formObj.whoType.length;i++){if(formObj.whoType[i].checked===true){type=formObj.whoType[i].value}}if((type==="user"||type==="group")&&formObj.who.value===""){alert("you must enter a user or group name");formObj.who.focus();return}const how=setAccessHow(formObj);this.addAce(new BwAce(formObj.who.value,type,how,"",false));formObj.who.value="";const formAcl=document.getElementById("bwCurrentAcl");formAcl.value=this.toXml();this.display(id)};this.deleteAce=function(index,id){let ace=aces[index];let replace=false;for(let si=0;si<savedInherited.length;si++){if(savedInherited[si].equals(ace)){ace=savedInherited[si];replace=true;break}}if(replace){aces[index]=ace}else{aces.splice(index,1)}var formAcl=document.getElementById("bwCurrentAcl");formAcl.value=this.toXml();this.display(id)};this.display=function(id){try{var aclWidget=document.getElementById(id);aclWidget.removeChild(aclWidget.firstChild);var bwCurrentAccess=document.createElement("table");bwCurrentAccess.className="common scheduling";bwCurrentAccess.id="bwCurrentAccess";bwCurrentAccess.createTHead();bwCurrAccessHead=bwCurrentAccess.tHead.insertRow(0);var th1=document.createElement("th");var txt1=document.createTextNode(bwAclWidgetEntryStr);var th2=document.createElement("th");var txt2=document.createTextNode(bwAclWidgetAccessStr);var th3=document.createElement("th");var txt3=document.createTextNode(bwAclWidgetInheritedStr);var th4=document.createElement("th");th1.appendChild(txt1);th2.appendChild(txt2);th3.appendChild(txt3);bwCurrAccessHead.appendChild(th1);bwCurrAccessHead.appendChild(th2);bwCurrAccessHead.appendChild(th3);bwCurrAccessHead.appendChild(th4);var bwCurrAccessTBody=document.createElement("tbody");bwCurrentAccess.appendChild(bwCurrAccessTBody);aclWidget.appendChild(bwCurrentAccess);var aclTableBody=document.getElementById("bwCurrentAccess").tBodies[0];for(var j=0;j<aces.length;j++){var curAce=aces[j];var tr=aclTableBody.insertRow(j);curAce.toFormRow(tr,j,id)}}catch(e){alert(e)}};this.toXml=function(){var res=xmlHeader+"\n<D:acl "+nameSpaces+" >\n";for(var j=0;j<aces.length;j++){res+=aces[j].toXml()}return res+"</D:acl>"}};